<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LangGo | Fact View</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
    }

    .content {
      flex: 1;
      padding: 40px;
    }

    h1 {
      margin-bottom: 10px;
    }

    #factDisplay {
      background: #fffbea;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 12px;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .word {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 6px;
    }

    .word:hover {
      background-color: #ffe066;
    }

    #translationBox {
      margin-top: 20px;
      background: #f8f8ff;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    .word.translated {
  background-color: #ffe066; /* hijau lembut */
  font-weight: bold;
}
.word.untranslated {
  background-color: #f0f0f0; /* kelabu lembut */
  opacity: 0.6;
}
  </style>
</head>
<body>
  <div class="container">
    <nav class="sidebar">
      <h2>LangGo</h2>
      <ul>
        <li><a href="index.html">Translate</a></li>
        <li><a href="add.html">Vocabulary</a></li>
        <li><a href="lyrics.html">Lyrics</a></li>
        <li><a class="active" href="fact.html">Facts</a></li>
      </ul>
    </nav>

    <main class="content">
      <h1>ğŸŒ Fact Detail</h1>
      <div id="factDisplay">Loading...</div>
      <div id="translationBox"></div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyCY685VUp-3SDJZcfbIwRFD20QXKIvyuD8",
      authDomain: "langgo-4bb3a.firebaseapp.com",
      projectId: "langgo-4bb3a",
      storageBucket: "langgo-4bb3a.appspot.com",
      messagingSenderId: "741690694912",
      appId: "1:741690694912:web:027b883b74e5fe217ca7e5"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
  
    const factDisplay = document.getElementById("factDisplay");
    const translationBox = document.getElementById("translationBox");
  
    const params = new URLSearchParams(window.location.search);
    const factId = params.get("id");
  
    // Load and display fact
    async function loadFact() {
      if (!factId) {
        factDisplay.textContent = "No fact selected.";
        return;
      }
  
      const docRef = doc(db, "facts", factId);
      const docSnap = await getDoc(docRef);
  
      if (!docSnap.exists()) {
        factDisplay.textContent = "Fact not found.";
        return;
      }
  
      const data = docSnap.data();
      const text = data.content || "";
  
      const translationSnapshot = await getDocs(collection(db, "translations"));
      const translatedWords = new Set();
      translationSnapshot.forEach(doc => {
        const d = doc.data();
        if (d.en) translatedWords.add(d.en.toLowerCase());
        if (d.ms) translatedWords.add(d.ms.toLowerCase());
        if (d.ko) translatedWords.add(d.ko.toLowerCase());
      });
  
      const formatted = text.split(/(\s+)/).map(part => {
        if (part.trim() === "") return part;
        const cleanWord = part.replace(/[.,!?;:()"'â€â€œ]/g, "").toLowerCase();
        const hasTranslation = translatedWords.has(cleanWord);
        const className = hasTranslation ? "word translated" : "word untranslated";
        return `<span class="${className}" onclick="translateWord('${part.replace(/'/g, "\\'")}')">${part}</span>`;
      }).join("");
  
      factDisplay.innerHTML = formatted;
    }
  
    // GLOBAL FUNCTION - Translate or add
    window.translateWord = async function (word) {
  const querySnapshot = await getDocs(collection(db, "translations"));
  let found = false;
  let docId = "";
  let translationData = null;

  const cleanWord = word.replace(/[.,!?;:()"'â€â€œ]/g, "").toLowerCase();

  querySnapshot.forEach(docSnap => {
    const data = docSnap.data();
    const values = [data.en, data.ms, data.ko].map(val => (val || "").toLowerCase());
    if (values.includes(cleanWord)) {
      found = true;
      docId = docSnap.id;
      translationData = data;
    }
  });

  if (found) {
    translationBox.innerHTML = `
      <strong>Word:</strong> ${word}<br>
      <div id="translationView">
        ğŸ‡¬ğŸ‡§ English: ${translationData.en}<br>
        ğŸ‡²ğŸ‡¾ Malay: ${translationData.ms}<br>
        ğŸ‡°ğŸ‡· Korean: ${translationData.ko}<br><br>
        <button onclick="editTranslation('${docId}', '${word}', '${translationData.en}', '${translationData.ms}', '${translationData.ko}')">âœï¸ Edit</button>
      </div>
    `;
  } else {
    translationBox.innerHTML = `
      <strong>Word:</strong> ${word}<br>
      âŒ No translation found.<br><br>
      <label>ğŸ‡¬ğŸ‡§ English: <input type="text" id="en-${cleanWord}"></label><br>
      <label>ğŸ‡²ğŸ‡¾ Malay: <input type="text" id="ms-${cleanWord}"></label><br>
      <label>ğŸ‡°ğŸ‡· Korean: <input type="text" id="ko-${cleanWord}"></label><br><br>
      <button onclick="addNewTranslation('${cleanWord}', '${word}')">â• Add Translation</button>
    `;
  }
};

window.editTranslation = function(docId, word, en, ms, ko) {
  translationBox.innerHTML = `
    <strong>Edit Translation for:</strong> ${word}<br><br>
    <label>ğŸ‡¬ğŸ‡§ English: <input type="text" id="edit-en" value="${en}"></label><br>
    <label>ğŸ‡²ğŸ‡¾ Malay: <input type="text" id="edit-ms" value="${ms}"></label><br>
    <label>ğŸ‡°ğŸ‡· Korean: <input type="text" id="edit-ko" value="${ko}"></label><br><br>
    <button onclick="saveTranslation('${docId}', '${word}')">ğŸ’¾ Save</button>
  `;
};

window.saveTranslation = async function(docId, word) {
  const newEn = document.getElementById("edit-en").value.trim();
  const newMs = document.getElementById("edit-ms").value.trim();
  const newKo = document.getElementById("edit-ko").value.trim();

  const docRef = doc(db, "translations", docId);
  await setDoc(docRef, {
    en: newEn,
    ms: newMs,
    ko: newKo
  });

  translationBox.innerHTML = `
    âœ… Translation updated!<br>
    ğŸ‡¬ğŸ‡§ English: ${newEn}<br>
    ğŸ‡²ğŸ‡¾ Malay: ${newMs}<br>
    ğŸ‡°ğŸ‡· Korean: ${newKo}
  `;
};
  
    // GLOBAL FUNCTION - Add translation
    window.addNewTranslation = async function (cleanWord, originalWord) {
      const en = document.getElementById(`en-${cleanWord}`).value.trim();
      const ms = document.getElementById(`ms-${cleanWord}`).value.trim();
      const ko = document.getElementById(`ko-${cleanWord}`).value.trim();
  
      if (!en && !ms && !ko) {
        alert("Please enter at least one translation.");
        return;
      }
  
      const data = {
        en: en || originalWord,
        ms: ms || originalWord,
        ko: ko || originalWord,
      };
  
      const docRef = doc(db, "translations", cleanWord);
      await setDoc(docRef, data);
  
      translationBox.innerHTML = `
        âœ… Translation added!<br>
        ğŸ‡¬ğŸ‡§ English: ${data.en}<br>
        ğŸ‡²ğŸ‡¾ Malay: ${data.ms}<br>
        ğŸ‡°ğŸ‡· Korean: ${data.ko}
      `;
  
      // Tukar warna perkataan di skrin
      const spans = document.querySelectorAll("span.word");
      spans.forEach(span => {
        const spanWord = span.textContent.replace(/[.,!?;:()"'â€â€œ]/g, "").toLowerCase();
        if (spanWord === cleanWord) {
          span.classList.remove("untranslated");
          span.classList.add("translated");
        }
      });
    };
  
    loadFact();
  </script>  
</body>
</html>
