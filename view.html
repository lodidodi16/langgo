<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LangGo | View Lyrics</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    #translatedWords span {
      margin: 3px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
      transition: background 0.3s;
    }
    #translatedWords span:hover {
      background: #efefef;
    }
    .translation-box {
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 5px;
      display: none;
    }
    .not-found {
      opacity: 0.4;
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="sidebar">
      <h2>LangGo</h2>
      <ul>
        <li><a href="index.html">Translate</a></li>
        <li><a href="add.html">Vocabulary</a></li>
        <li><a class="active" href="lyrics.html">Lyrics</a></li>
        <li><a href="flashcard.html">Flashcard</a></li>
        <li><a href="fact.html">Fact</a></li>
      </ul>
    </nav>
    <main class="content">
      <h1 id="lyricTitle">Loading...</h1>
      <div class="card">
        <select id="fromLang">
          <option value="en">English</option>
          <option value="ms">Malay</option>
          <option value="ko">Korean</option>
          <option value="fil">Filipino</option>
          <option value="de">German</option>
          <option value="zh">Chinese</option>
          <option value="ja">Japanese</option>
          <option value="fr">French</option>
        </select>
        <select id="toLang">
          <option value="ms">Malay</option>
          <option value="ko">Korean</option>
          <option value="en">English</option>
          <option value="fil">Filipino</option>
          <option value="de">German</option>
          <option value="zh">Chinese</option>
          <option value="ja">Japanese</option>
          <option value="fr">French</option>
        </select>
        <button onclick="translateLyrics()">Translate</button>
        <div id="translatedWords" style="margin-top: 20px;"></div>
      </div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyCY685VUp-3SDJZcfbIwRFD20QXKIvyuD8",
      authDomain: "langgo-4bb3a.firebaseapp.com",
      projectId: "langgo-4bb3a",
      storageBucket: "langgo-4bb3a.appspot.com",
      messagingSenderId: "741690694912",
      appId: "1:741690694912:web:027b883b74e5fe217ca7e5",
      measurementId: "G-ZFSJ67X5WF"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
  
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    let originalText = "";
  
    const titleEl = document.getElementById("lyricTitle");
    const outputDiv = document.getElementById("translatedWords");
  
    const fetchLyric = async () => {
      const docRef = doc(db, "lyrics", id);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        titleEl.innerText = data.title;
        originalText = data.content.trim();
        translateLyrics();
      } else {
        titleEl.innerText = "Not Found";
        originalText = "";
      }
    };
  
    window.translateLyrics = async () => {
      const from = document.getElementById("fromLang").value;
      const to = document.getElementById("toLang").value;
      outputDiv.innerHTML = "";
  
      const paragraphs = originalText.split(/\n+/);
  
      for (let para of paragraphs) {
        const paraDiv = document.createElement("div");
        paraDiv.style.marginBottom = "16px";
  
        const words = para.trim().split(/\s+/);
  
        for (let word of words) {
          const cleanWord = word.toLowerCase().replace(/[^a-zA-Z가-힣]/g, "");
          const docRef = doc(db, "translations", cleanWord);
          const docSnap = await getDoc(docRef);
  
          const span = document.createElement("span");
          span.textContent = word;
          span.setAttribute("data-word", cleanWord);
          span.style.marginRight = "5px";
  
          const box = document.createElement("div");
          box.className = "translation-box";
  
          if (docSnap.exists()) {
            const docData = docSnap.data();
            span.title = docData[to] || "-";
  
            let displayTranslations = "";
            let editTranslations = "";
            for (const [lang, value] of Object.entries(docData)) {
              displayTranslations += `<strong>${lang.toUpperCase()}</strong>: ${value}<br/>`;
              editTranslations += `
                <label><strong>${lang.toUpperCase()}</strong>: 
                  <input type="text" id="edit-${lang}-${cleanWord}" value="${value}" />
                </label><br/>
              `;
            }
  
            const editBoxId = `edit-box-${cleanWord}`;
            box.innerHTML = `
              <div class="view-mode">${displayTranslations}</div>
              <button onclick="toggleEditBox('${editBoxId}', this)">Edit</button>
              <div class="edit-mode" id="${editBoxId}" style="display:none;">
                ${editTranslations}
                <button onclick="editTranslation('${cleanWord}')">Save</button>
              </div>
            `;
  
            span.onclick = () => {
              box.style.display = box.style.display === "none" ? "block" : "none";
            };
  
            paraDiv.appendChild(span);
            paraDiv.appendChild(box);
          } else {
            span.classList.add("not-found");
  
            const addBox = document.createElement("div");
            addBox.className = "translation-box";
            addBox.innerHTML = `
              <small>No translation. Add for all languages:</small><br/>
              <input type="text" placeholder="English" id="add-en-${cleanWord}" /><br/>
              <input type="text" placeholder="Malay" id="add-ms-${cleanWord}" /><br/>
              <input type="text" placeholder="Korean" id="add-ko-${cleanWord}" /><br/>
              <input type="text" placeholder="Filipino" id="add-fil-${cleanWord}" /><br/>
              <input type="text" placeholder="German" id="add-de-${cleanWord}" /><br/>
              <input type="text" placeholder="Chinese" id="add-zh-${cleanWord}" /><br/>
              <input type="text" placeholder="Japanese" id="add-ja-${cleanWord}" /><br/>
              <input type="text" placeholder="French" id="add-fr-${cleanWord}" /><br/>
              <button onclick="addTranslationMulti('${cleanWord}')">Add All</button>
            `;
  
            span.onclick = () => {
              addBox.style.display = addBox.style.display === "none" ? "block" : "none";
            };
  
            paraDiv.appendChild(span);
            paraDiv.appendChild(addBox);
          }
        }
  
        outputDiv.appendChild(paraDiv);
      }
    };
  
    window.toggleEditBox = (id, btn) => {
      const box = document.getElementById(id);
      const buttonText = btn.textContent;
      if (box.style.display === "none") {
        box.style.display = "block";
        btn.textContent = "Cancel";
      } else {
        box.style.display = "none";
        btn.textContent = "Edit";
      }
    };
  
    window.editTranslation = async (word) => {
      const langs = ["en", "ms", "ko", "fil", "de", "zh", "ja", "fr"];
      const updates = {};
  
      langs.forEach(lang => {
        const input = document.getElementById(`edit-${lang}-${word}`);
        if (input && input.value.trim()) {
          updates[lang] = input.value.trim();
        }
      });
  
      if (Object.keys(updates).length > 0) {
        const docRef = doc(db, "translations", word);
        await setDoc(docRef, updates, { merge: true });
        alert("✅ Translation updated!");
  
        const span = document.querySelector(`span[data-word="${word}"]`);
        const toLang = document.getElementById("toLang").value;
        if (span && updates[toLang]) {
          span.title = updates[toLang];
        }
  
        const editBox = document.getElementById(`edit-box-${word}`);
        if (editBox) editBox.style.display = "none";
      }
    };
  
    window.addTranslationMulti = async (word) => {
      const langs = ["en", "ms", "ko", "fil", "de", "zh", "ja", "fr"];
      const data = {};
  
      for (const lang of langs) {
        const input = document.getElementById(`add-${lang}-${word}`);
        const value = input?.value?.trim();
        if (value) {
          data[lang] = value;
        }
      }
  
      const from = document.getElementById("fromLang").value;
      const to = document.getElementById("toLang").value;
  
      if (!data[from]) {
        data[from] = word;
      }
  
      const docRef = doc(db, "translations", word);
      await setDoc(docRef, data, { merge: true });
  
      const span = document.querySelector(`span[data-word="${word}"]`);
      const box = span?.nextElementSibling;
  
      if (span && box) {
        span.classList.remove("not-found");
        span.title = data[to] || "-";
  
        let newContent = "";
        for (const [lang, value] of Object.entries(data)) {
          newContent += `<strong>${lang.toUpperCase()}</strong>: ${value}<br/>`;
        }
  
        box.innerHTML = `
          <div class="view-mode">${newContent}</div>
          <button onclick="toggleEditBox('edit-box-${word}', this)">Edit</button>
          <div class="edit-mode" id="edit-box-${word}" style="display:none;">
            ${langs.map(lang => `
              <label><strong>${lang.toUpperCase()}</strong>: 
                <input type="text" id="edit-${lang}-${word}" value="${data[lang] || ""}" />
              </label><br/>
            `).join("")}
            <button onclick="editTranslation('${word}')">Save</button>
          </div>
        `;
      }
    };
  
    fetchLyric();
  
    document.addEventListener("click", (e) => {
      const isInsideSpan = e.target.closest("span[data-word]");
      const isInsideBox = e.target.closest(".translation-box");
  
      if (!isInsideSpan && !isInsideBox) {
        document.querySelectorAll(".translation-box").forEach(box => {
          box.style.display = "none";
        });
      }
    });
  </script>
</body>
</html>
